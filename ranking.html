<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蛋筒时间排行榜 - Limbus Company</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/module/dynamic-styles.css">
    <style>
        /* 标签页切换样式 */
        .ranking-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 15px 35px;
            font-size: 1.2rem;
            border-radius: 30px;
            border: 2px solid #d4af37;
            background: rgba(20, 20, 30, 0.8);
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .tab-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }
        
        .tab-btn.active {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 罪人导航样式 */
        .sinner-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(10, 10, 10, 0.5);
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        .sinner-nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 25px;
            border: 2px solid rgba(212, 175, 55, 0.5);
            background: rgba(20, 20, 30, 0.8);
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .sinner-nav-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            transform: translateY(-2px);
        }
        
        .sinner-nav-btn.active {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #000;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        
        .sinner-nav-btn img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid currentColor;
        }
        
        .sinner-nav-btn .sinner-nav-placeholder {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid currentColor;
        }
        
        /* 人格导航样式 */
        .persona-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            padding: 12px;
            background: rgba(30, 30, 40, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .persona-nav-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.4);
            background: rgba(20, 20, 30, 0.7);
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .persona-nav-btn:hover {
            background: rgba(212, 175, 55, 0.15);
            color: #d4af37;
        }
        
        .persona-nav-btn.active {
            background: rgba(212, 175, 55, 0.3);
            border-color: #d4af37;
            color: #d4af37;
        }
        
        .persona-nav-btn img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .persona-nav-btn .persona-nav-placeholder {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        /* 排行榜列表样式 */
        .ranking-list {
            margin: 20px 0;
        }
        
        .ranking-item {
            background: rgba(10, 10, 10, 0.7);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }
        
        .ranking-item:hover {
            background: rgba(20, 20, 30, 0.8);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        .ranking-number {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
            min-width: 50px;
            text-align: center;
        }
        
        .character-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #d4af37;
            object-fit: cover;
        }
        
        .character-avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #d4af37;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #888;
        }
        
        .character-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .character-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #d4af37;
        }
        
        .personality-name {
            font-size: 1rem;
            color: #aaa;
        }
        
        .ranking-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }
        
        .ranking-date {
            font-size: 0.9rem;
            color: #888;
        }
        
        .ranking-comment {
            font-size: 0.95rem;
            color: #ccc;
        }
        
        .ranking-time {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d4af37;
            min-width: 120px;
            text-align: right;
        }
        
        .no-records {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.5rem;
            color: #888;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        /* 联网排行榜特有样式 */
        .sinner-group {
            margin-bottom: 40px;
        }
        
        .sinner-group-title {
            font-size: 1.8rem;
            color: #d4af37;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d4af37;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sinner-group-title img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #d4af37;
        }
        
        .persona-group {
            margin-bottom: 25px;
        }
        
        .persona-group-title {
            font-size: 1.3rem;
            color: #aaa;
            margin-bottom: 15px;
            padding-left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .persona-group-title img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #aaa;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.5rem;
            color: #d4af37;
        }
        
        .error-message {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.2rem;
            color: #ff6b6b;
        }
        
        /* 最后更新时间样式 */
        .last-update-info {
            text-align: center;
            padding: 10px 20px;
            font-size: 0.9rem;
            color: #888;
            background: rgba(10, 10, 10, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .last-update-info i {
            margin-right: 5px;
            color: #d4af37;
        }
        
        /* 截图展开按钮样式 */
        .screenshot-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            font-size: 0.8rem;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid rgba(212, 175, 55, 0.5);
            border-radius: 15px;
            color: #d4af37;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }
        
        .screenshot-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }
        
        .screenshot-btn.active {
            background: rgba(212, 175, 55, 0.4);
        }
        
        /* 截图容器样式 */
        .screenshot-container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            animation: slideDown 0.3s ease;
        }
        
        .screenshot-container.active {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
        
        .screenshot-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            border: 2px solid rgba(212, 175, 55, 0.5);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .screenshot-container img:hover {
            transform: scale(1.02);
        }
        
        .screenshot-loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        /* 移动端响应式样式 */
        @media (max-width: 768px) {
            .ranking-tabs {
                gap: 10px;
                margin: 20px 0;
            }
            
            .tab-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .sinner-nav {
                gap: 6px;
                padding: 10px;
            }
            
            .sinner-nav-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .sinner-nav-btn img,
            .sinner-nav-btn .sinner-nav-placeholder {
                width: 24px;
                height: 24px;
            }
            
            .sinner-nav-btn span {
                display: none;
            }
            
            .persona-nav {
                gap: 6px;
                padding: 8px;
            }
            
            .persona-nav-btn {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .persona-nav-btn img,
            .persona-nav-btn .persona-nav-placeholder {
                width: 20px;
                height: 20px;
            }
            
            .ranking-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 10px;
                position: relative;
            }
            
            .ranking-number {
                font-size: 1.5rem;
                min-width: auto;
                position: absolute;
                top: 10px;
                right: 10px;
            }
            
            .character-info {
                width: 100%;
            }
            
            .character-avatar,
            .character-avatar-placeholder {
                width: 50px;
                height: 50px;
            }
            
            .character-name {
                font-size: 1rem;
            }
            
            .personality-name {
                font-size: 0.85rem;
            }
            
            .ranking-info {
                width: 100%;
            }
            
            .ranking-time {
                font-size: 1.4rem;
                min-width: auto;
                text-align: left;
                width: 100%;
                padding-top: 10px;
                border-top: 1px solid rgba(212, 175, 55, 0.3);
            }
            
            .sinner-group-title {
                font-size: 1.3rem;
            }
            
            .sinner-group-title img {
                width: 32px;
                height: 32px;
            }
            
            .persona-group-title {
                font-size: 1rem;
                padding-left: 10px;
            }
            
            .persona-group-title img {
                width: 26px;
                height: 26px;
            }
            
            .actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .actions .control-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .ranking-tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab-btn {
                width: 100%;
            }
            
            .sinner-nav-btn {
                padding: 5px 8px;
            }
            
            .sinner-nav-btn img,
            .sinner-nav-btn .sinner-nav-placeholder {
                width: 22px;
                height: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-trophy"></i>蛋筒时间排行榜</h1>
        
        <!-- 标签页切换 -->
        <div class="ranking-tabs">
            <button id="local-tab-btn" class="tab-btn active">
                <i class="fas fa-building"></i> 部门记录（本地）
            </button>
            <button id="global-tab-btn" class="tab-btn">
                <i class="fas fa-broadcast-tower"></i> 都市广播（联网）
            </button>
            <button id="floor-tab-btn" class="tab-btn">
                <i class="fas fa-layer-group"></i> 单通层数（联网）
            </button>
        </div>
        
        <!-- 本地排行榜 -->
        <div id="local-ranking" class="tab-content active">
            <div id="local-ranking-list" class="ranking-list">
                <!-- 本地排行榜记录将通过JavaScript动态添加 -->
            </div>
            <div class="actions">
                <button id="back-btn" class="control-btn primary-btn">
                    <i class="fas fa-arrow-left"></i> 返回主页
                </button>
                <button id="clear-local-btn" class="control-btn">
                    <i class="fas fa-trash"></i> 清空本地记录
                </button>
            </div>
        </div>
        
        <!-- 联网排行榜 -->
        <div id="global-ranking" class="tab-content">
            <!-- 最后更新时间 -->
            <div id="global-last-update" class="last-update-info" style="display: none;">
                <i class="fas fa-clock"></i> 最后更新：<span id="global-update-time">--</span>
            </div>
            <!-- 罪人导航 -->
            <div id="global-sinner-nav" class="sinner-nav">
                <!-- 罪人导航按钮将通过JavaScript动态添加 -->
            </div>
            <!-- 人格导航 -->
            <div id="global-persona-nav" class="persona-nav" style="display: none;">
                <!-- 人格导航按钮将通过JavaScript动态添加 -->
            </div>
            <div id="global-ranking-list" class="ranking-list">
                <!-- 联网排行榜记录将通过JavaScript动态添加 -->
            </div>
            <div class="actions">
                <button id="back-btn-2" class="control-btn primary-btn">
                    <i class="fas fa-arrow-left"></i> 返回主页
                </button>
                <button id="refresh-global-btn" class="control-btn">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
            </div>
        </div>
        
        <!-- 层数排行榜 -->
        <div id="floor-ranking" class="tab-content">
            <!-- 最后更新时间 -->
            <div id="floor-last-update" class="last-update-info" style="display: none;">
                <i class="fas fa-clock"></i> 最后更新：<span id="floor-update-time">--</span>
            </div>
            <!-- 罪人导航 -->
            <div id="floor-sinner-nav" class="sinner-nav">
                <!-- 罪人导航按钮将通过JavaScript动态添加 -->
            </div>
            <!-- 人格导航 -->
            <div id="floor-persona-nav" class="persona-nav" style="display: none;">
                <!-- 人格导航按钮将通过JavaScript动态添加 -->
            </div>
            <div id="floor-ranking-list" class="ranking-list">
                <!-- 层数排行榜记录将通过JavaScript动态添加 -->
            </div>
            <div class="actions">
                <button id="back-btn-3" class="control-btn primary-btn">
                    <i class="fas fa-arrow-left"></i> 返回主页
                </button>
                <button id="refresh-floor-btn" class="control-btn">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // 导入自定义弹窗模块
        import Modal from './js/modal.js';
        // 导入罪人数据（用于显示罪人信息）
        import { sinnerData } from './data/characters.js';
        // 导入人格管理器（处理人格名称映射和头像查找）
        import { PersonaManager } from './data/personaManager.js';
        
        // 全局状态存储
        let globalRankingData = null;
        let floorRankingData = null;
        let globalSelectedSinner = 'all';
        let globalSelectedPersona = 'all';
        let floorSelectedSinner = 'all';
        let floorSelectedPersona = 'all';
        // 当前展开的截图记录ID（一次只展开一个）
        let currentExpandedScreenshot = null;
        
        // 格式化日期时间（用于显示最后更新时间）
        function formatDateTime(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return '--';
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // HTML 转义函数（防止 XSS）
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // 格式化时间（秒 -> HH:MM:SS）
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // 根据人格名称查找人格头像（使用PersonaManager支持名称映射）
        function findPersonaAvatar(sinnerId, personaName) {
            return PersonaManager.findPersonaAvatar(sinnerId, personaName);
        }
        
        // 根据罪人ID获取罪人数据
        function getSinnerById(sinnerId) {
            return PersonaManager.getSinnerById(sinnerId);
        }
        
        // 创建罪人头像HTML（添加懒加载优化）
        function createSinnerAvatarHTML(sinner, size = 30) {
            if (sinner && sinner.avatar) {
                return `<img src="${sinner.avatar}" alt="${sinner.name}" loading="lazy" style="width:${size}px;height:${size}px;" onerror="this.outerHTML='<div class=\\'sinner-nav-placeholder\\'>?</div>'">`;
            }
            return `<div class="sinner-nav-placeholder">?</div>`;
        }
        
        // 创建人格头像HTML（添加懒加载优化）
        function createPersonaAvatarHTML(avatarPath, size = 24, placeholderClass = 'persona-nav-placeholder') {
            if (avatarPath) {
                return `<img src="${avatarPath}" alt="头像" loading="lazy" style="width:${size}px;height:${size}px;" onerror="this.outerHTML='<div class=\\'${placeholderClass}\\'>?</div>'">`;
            }
            return `<div class="${placeholderClass}">?</div>`;
        }
        
        // 创建排行榜项HTML（本地排行）
        function createRankingItemHTML(record, index) {
            const sinner = record.sinner;
            const persona = record.persona;
            
            // 获取人格头像
            let personaAvatar = null;
            if (sinner && persona) {
                personaAvatar = persona.avatar;
            }
            
            return `
                <div class="ranking-item">
                    <div class="ranking-number">${index + 1}</div>
                    ${sinner ? `
                        <div class="character-info">
                            ${personaAvatar ? 
                                `<img src="${personaAvatar}" alt="${persona.name}" class="character-avatar" loading="lazy" onerror="this.outerHTML='<div class=\\'character-avatar-placeholder\\'>?</div>'">` :
                                `<img src="${sinner.avatar}" alt="${sinner.name}" class="character-avatar" loading="lazy" onerror="this.outerHTML='<div class=\\'character-avatar-placeholder\\'>?</div>'">`
                            }
                            <div class="character-details">
                                <div class="character-name">${sinner.name}</div>
                                ${persona ? `<div class="personality-name">${persona.name}</div>` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="character-info">
                            <div class="character-avatar-placeholder">?</div>
                            <div class="character-details">
                                <div class="character-name">未选择罪人</div>
                                <div class="personality-name">未选择人格</div>
                            </div>
                        </div>
                    `}
                    <div class="ranking-info">
                        <div class="ranking-date">${new Date(record.timestamp).toLocaleString()}</div>
                        <div class="ranking-comment">${record.comment || '无备注'}</div>
                    </div>
                    <div class="ranking-time">${formatTime(record.time)}</div>
                </div>
            `;
        }
        
        // ======================
        // 罪人导航逻辑
        // ======================
        
        function renderSinnerNav(containerId, selectedSinner, onSelect) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = `
                <button class="sinner-nav-btn ${selectedSinner === 'all' ? 'active' : ''}" data-sinner-id="all">
                    <i class="fas fa-users"></i>
                    <span>全部</span>
                </button>
            `;
            
            sinnerData.forEach(sinner => {
                html += `
                    <button class="sinner-nav-btn ${selectedSinner === sinner.id.toString() ? 'active' : ''}" data-sinner-id="${sinner.id}">
                        ${createSinnerAvatarHTML(sinner, 30)}
                        <span>${sinner.name.split(' ')[0]}</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加点击事件
            container.querySelectorAll('.sinner-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const sinnerId = btn.dataset.sinnerId;
                    onSelect(sinnerId);
                });
            });
        }
        
        // ======================
        // 人格导航逻辑
        // ======================
        
        function renderPersonaNav(containerId, sinnerId, personas, selectedPersona, onSelect) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // 如果选择"全部"罪人，隐藏人格导航
            if (sinnerId === 'all' || !personas || Object.keys(personas).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            let html = `
                <button class="persona-nav-btn ${selectedPersona === 'all' ? 'active' : ''}" data-persona-name="all">
                    <i class="fas fa-th"></i>
                    <span>全部人格</span>
                </button>
            `;
            
            for (const personaName in personas) {
                const avatarPath = findPersonaAvatar(sinnerId, personaName);
                html += `
                    <button class="persona-nav-btn ${selectedPersona === personaName ? 'active' : ''}" data-persona-name="${personaName}">
                        ${createPersonaAvatarHTML(avatarPath, 24)}
                        <span>${personaName}</span>
                    </button>
                `;
            }
            
            container.innerHTML = html;
            
            // 添加点击事件
            container.querySelectorAll('.persona-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const personaName = btn.dataset.personaName;
                    onSelect(personaName);
                });
            });
        }
        
        // ======================
        // 本地排行榜逻辑
        // ======================
        
        function loadLocalRanking() {
            const rankingList = document.getElementById('local-ranking-list');
            const records = JSON.parse(localStorage.getItem('personalRanking') || '[]');
            
            if (records.length === 0) {
                rankingList.innerHTML = '<div class="no-records">暂无记录</div>';
                return;
            }
            
            // 按时间升序排序
            records.sort((a, b) => a.time - b.time);
            
            rankingList.innerHTML = records.map((record, index) => createRankingItemHTML(record, index)).join('');
        }
        
        async function clearLocalRecords() {
            const confirmed = await Modal.confirm('确定要清空所有本地排行榜记录吗？此操作不可恢复。', '确认');
            if (confirmed) {
                localStorage.removeItem('personalRanking');
                loadLocalRanking();
                await Modal.alert('本地记录已清空', '成功');
            }
        }
        
        // ======================
        // 联网排行榜逻辑
        // ======================
        
        async function loadGlobalRanking() {
            const rankingList = document.getElementById('global-ranking-list');
            rankingList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在加载数据...</div>';
            
            try {
                const response = await fetch('./data/global-ranking.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                globalRankingData = await response.json();
                
                // 显示最后更新时间
                const lastUpdateEl = document.getElementById('global-last-update');
                const updateTimeEl = document.getElementById('global-update-time');
                if (globalRankingData.lastUpdate) {
                    updateTimeEl.textContent = formatDateTime(globalRankingData.lastUpdate);
                    lastUpdateEl.style.display = 'block';
                }
                
                // 渲染罪人导航
                renderSinnerNav('global-sinner-nav', globalSelectedSinner, (sinnerId) => {
                    globalSelectedSinner = sinnerId;
                    globalSelectedPersona = 'all';
                    renderGlobalRankingContent();
                });
                
                // 渲染排行榜内容
                renderGlobalRankingContent();
                
            } catch (error) {
                console.error('加载全球排行榜失败:', error);
                rankingList.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        加载失败：${error.message}<br>
                        <small>请检查网络连接或稍后重试</small>
                    </div>
                `;
            }
        }
        
        function renderGlobalRankingContent() {
            const rankingList = document.getElementById('global-ranking-list');
            const data = globalRankingData;
            
            if (!data) return;
            
            // 检查是否有数据
            let hasData = false;
            for (const sinnerId in data.sinners) {
                const sinner = data.sinners[sinnerId];
                if (sinner.personas && Object.keys(sinner.personas).length > 0) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                document.getElementById('global-persona-nav').style.display = 'none';
                rankingList.innerHTML = '<div class="no-records">暂无全球排行榜记录<br>您可以成为第一个提交者！</div>';
                return;
            }
            
            // 如果选择了特定罪人，渲染人格导航
            if (globalSelectedSinner !== 'all') {
                const sinnerData = data.sinners[globalSelectedSinner];
                if (sinnerData && sinnerData.personas) {
                    renderPersonaNav('global-persona-nav', globalSelectedSinner, sinnerData.personas, globalSelectedPersona, (personaName) => {
                        globalSelectedPersona = personaName;
                        renderGlobalRankingContent();
                    });
                }
            } else {
                document.getElementById('global-persona-nav').style.display = 'none';
            }
            
            // 更新罪人导航激活状态
            document.querySelectorAll('#global-sinner-nav .sinner-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sinnerId === globalSelectedSinner);
            });
            
            // 按罪人和人格分组显示
            let html = '';
            
            // 确定要显示的罪人列表
            const sinnerIds = globalSelectedSinner === 'all' 
                ? Object.keys(data.sinners).sort((a, b) => parseInt(a) - parseInt(b))
                : [globalSelectedSinner];
            
            for (const sinnerId of sinnerIds) {
                const sinner = data.sinners[sinnerId];
                if (!sinner || !sinner.personas || Object.keys(sinner.personas).length === 0) {
                    continue;
                }
                
                const sinnerInfo = getSinnerById(sinnerId);
                const sinnerAvatarHTML = sinnerInfo ? `<img src="${sinnerInfo.avatar}" alt="${sinner.name}" loading="lazy" onerror="this.style.display='none'">` : '';
                
                html += `<div class="sinner-group">`;
                html += `<div class="sinner-group-title">${sinnerAvatarHTML} ${sinner.name}</div>`;
                
                // 确定要显示的人格列表
                const personaNames = globalSelectedPersona === 'all'
                    ? Object.keys(sinner.personas)
                    : [globalSelectedPersona];
                
                // 遍历该罪人的每个人格
                for (const personaName of personaNames) {
                    const records = sinner.personas[personaName];
                    if (!records || records.length === 0) continue;
                    
                    const personaAvatar = findPersonaAvatar(sinnerId, personaName);
                    const personaAvatarHTML = personaAvatar ? `<img src="${personaAvatar}" alt="${personaName}" loading="lazy" onerror="this.style.display='none'">` : '';
                    
                    html += `<div class="persona-group">`;
                    html += `<div class="persona-group-title">${personaAvatarHTML} ${personaName}</div>`;
                    
                    // 显示该人格的所有记录（已排序）
                    records.forEach((record, index) => {
                        const recordId = `global-${sinnerId}-${personaName}-${index}`;
                        const hasScreenshot = record.screenshotUrl ? true : false;
                        html += `
                            <div class="ranking-item">
                                <div class="ranking-number">${index + 1}</div>
                                <div class="character-info">
                                    ${personaAvatar ? 
                                        `<img src="${personaAvatar}" alt="${personaName}" class="character-avatar" loading="lazy" onerror="this.outerHTML='<div class=\\'character-avatar-placeholder\\'>?</div>'">` :
                                        `<div class="character-avatar-placeholder">?</div>`
                                    }
                                    <div class="character-details">
                                        <div class="character-name">${escapeHtml(sinner.name)}</div>
                                        <div class="personality-name">${escapeHtml(personaName)}</div>
                                    </div>
                                </div>
                                <div class="ranking-info">
                                    <div class="ranking-date">${new Date(record.runDate).toLocaleDateString()}</div>
                                    <div class="ranking-comment">${escapeHtml(record.comment) || '无备注'}</div>
                                    ${hasScreenshot ? `
                                        <button class="screenshot-btn" data-record-id="${escapeHtml(recordId)}" data-screenshot-url="${escapeHtml(record.screenshotUrl)}" onclick="toggleScreenshot(this)">
                                            <i class="fas fa-image"></i> 查看截图
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="ranking-time">${formatTime(record.clearTime)}</div>
                            </div>
                            ${hasScreenshot ? `
                                <div id="screenshot-${escapeHtml(recordId)}" class="screenshot-container">
                                    <div class="screenshot-loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>
                                </div>
                            ` : ''}
                        `;
                    });
                    
                    html += `</div>`; // persona-group
                }
                
                html += `</div>`; // sinner-group
            }
            
            if (html === '') {
                rankingList.innerHTML = '<div class="no-records">当前筛选条件下暂无记录</div>';
            } else {
                rankingList.innerHTML = html;
            }
        }
        
        // ======================
        // 层数排行榜逻辑
        // ======================
        
        async function loadFloorRanking() {
            const rankingList = document.getElementById('floor-ranking-list');
            rankingList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 正在加载数据...</div>';
            
            try {
                const response = await fetch('./data/global-floor-ranking.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                floorRankingData = await response.json();
                
                // 显示最后更新时间
                const lastUpdateEl = document.getElementById('floor-last-update');
                const updateTimeEl = document.getElementById('floor-update-time');
                if (floorRankingData.lastUpdate) {
                    updateTimeEl.textContent = formatDateTime(floorRankingData.lastUpdate);
                    lastUpdateEl.style.display = 'block';
                }
                
                // 渲染罪人导航
                renderSinnerNav('floor-sinner-nav', floorSelectedSinner, (sinnerId) => {
                    floorSelectedSinner = sinnerId;
                    floorSelectedPersona = 'all';
                    renderFloorRankingContent();
                });
                
                // 渲染排行榜内容
                renderFloorRankingContent();
                
            } catch (error) {
                console.error('加载层数排行榜失败:', error);
                rankingList.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        加载失败：${error.message}<br>
                        <small>请检查网络连接或稍后重试</small>
                    </div>
                `;
            }
        }
        
        function renderFloorRankingContent() {
            const rankingList = document.getElementById('floor-ranking-list');
            const data = floorRankingData;
            
            if (!data) return;
            
            // 检查是否有数据
            let hasData = false;
            for (const sinnerId in data.sinners) {
                const sinner = data.sinners[sinnerId];
                if (sinner.personas && Object.keys(sinner.personas).length > 0) {
                    hasData = true;
                    break;
                }
            }
            
            if (!hasData) {
                document.getElementById('floor-persona-nav').style.display = 'none';
                rankingList.innerHTML = '<div class="no-records">暂无层数排行榜记录<br>您可以成为第一个提交者！</div>';
                return;
            }
            
            // 如果选择了特定罪人，渲染人格导航
            if (floorSelectedSinner !== 'all') {
                const sinnerData = data.sinners[floorSelectedSinner];
                if (sinnerData && sinnerData.personas) {
                    renderPersonaNav('floor-persona-nav', floorSelectedSinner, sinnerData.personas, floorSelectedPersona, (personaName) => {
                        floorSelectedPersona = personaName;
                        renderFloorRankingContent();
                    });
                }
            } else {
                document.getElementById('floor-persona-nav').style.display = 'none';
            }
            
            // 更新罪人导航激活状态
            document.querySelectorAll('#floor-sinner-nav .sinner-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sinnerId === floorSelectedSinner);
            });
            
            // 按罪人和人格分组显示
            let html = '';
            
            // 确定要显示的罪人列表
            const sinnerIds = floorSelectedSinner === 'all' 
                ? Object.keys(data.sinners).sort((a, b) => parseInt(a) - parseInt(b))
                : [floorSelectedSinner];
            
            for (const sinnerId of sinnerIds) {
                const sinner = data.sinners[sinnerId];
                if (!sinner || !sinner.personas || Object.keys(sinner.personas).length === 0) {
                    continue;
                }
                
                const sinnerInfo = getSinnerById(sinnerId);
                const sinnerAvatarHTML = sinnerInfo ? `<img src="${sinnerInfo.avatar}" alt="${sinner.name}" loading="lazy" onerror="this.style.display='none'">` : '';
                
                html += `<div class="sinner-group">`;
                html += `<div class="sinner-group-title">${sinnerAvatarHTML} ${sinner.name}</div>`;
                
                // 确定要显示的人格列表
                const personaNames = floorSelectedPersona === 'all'
                    ? Object.keys(sinner.personas)
                    : [floorSelectedPersona];
                
                // 遍历该罪人的每个人格
                for (const personaName of personaNames) {
                    const records = sinner.personas[personaName];
                    if (!records || records.length === 0) continue;
                    
                    const personaAvatar = findPersonaAvatar(sinnerId, personaName);
                    const personaAvatarHTML = personaAvatar ? `<img src="${personaAvatar}" alt="${personaName}" loading="lazy" onerror="this.style.display='none'">` : '';
                    
                    html += `<div class="persona-group">`;
                    html += `<div class="persona-group-title">${personaAvatarHTML} ${personaName}</div>`;
                    
                    // 显示该人格的所有记录（已排序）
                    records.forEach((record, index) => {
                        const floorText = `第${record.floorLevel}层`;
                        const recordId = `floor-${sinnerId}-${personaName}-${index}`;
                        const hasScreenshot = record.screenshotUrl ? true : false;
                        html += `
                            <div class="ranking-item">
                                <div class="ranking-number">${index + 1}</div>
                                <div class="character-info">
                                    ${personaAvatar ? 
                                        `<img src="${personaAvatar}" alt="${personaName}" class="character-avatar" loading="lazy" onerror="this.outerHTML='<div class=\\'character-avatar-placeholder\\'>?</div>'">` :
                                        `<div class="character-avatar-placeholder">?</div>`
                                    }
                                    <div class="character-details">
                                        <div class="character-name">${escapeHtml(sinner.name)}</div>
                                        <div class="personality-name">${escapeHtml(personaName)}</div>
                                    </div>
                                </div>
                                <div class="ranking-info">
                                    <div class="ranking-date">${new Date(record.runDate).toLocaleDateString()}</div>
                                    <div class="ranking-comment">${escapeHtml(record.comment) || '无备注'}</div>
                                    ${hasScreenshot ? `
                                        <button class="screenshot-btn" data-record-id="${escapeHtml(recordId)}" data-screenshot-url="${escapeHtml(record.screenshotUrl)}" onclick="toggleScreenshot(this)">
                                            <i class="fas fa-image"></i> 查看截图
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="ranking-time">${floorText}</div>
                            </div>
                            ${hasScreenshot ? `
                                <div id="screenshot-${escapeHtml(recordId)}" class="screenshot-container">
                                    <div class="screenshot-loading"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>
                                </div>
                            ` : ''}
                        `;
                    });
                    
                    html += `</div>`; // persona-group
                }
                
                html += `</div>`; // sinner-group
            }
            
            if (html === '') {
                rankingList.innerHTML = '<div class="no-records">当前筛选条件下暂无记录</div>';
            } else {
                rankingList.innerHTML = html;
            }
        }
        
        // ======================
        // 标签页切换逻辑
        // ======================
        
        function switchTab(tabName) {
            // 切换按钮状态
            document.getElementById('local-tab-btn').classList.toggle('active', tabName === 'local');
            document.getElementById('global-tab-btn').classList.toggle('active', tabName === 'global');
            document.getElementById('floor-tab-btn').classList.toggle('active', tabName === 'floor');
            
            // 切换内容区域
            document.getElementById('local-ranking').classList.toggle('active', tabName === 'local');
            document.getElementById('global-ranking').classList.toggle('active', tabName === 'global');
            document.getElementById('floor-ranking').classList.toggle('active', tabName === 'floor');
            
            // 加载对应数据
            if (tabName === 'local') {
                loadLocalRanking();
            } else if (tabName === 'global') {
                loadGlobalRanking();
            } else if (tabName === 'floor') {
                loadFloorRanking();
            }
        }
        
        // ======================
        // 页面初始化
        // ======================
        
        function goToHomePage() {
            window.location.href = 'index.html';
        }
        
        // 截图展开/收起函数（挂载到window以便onclick调用）
        window.toggleScreenshot = function(button) {
            const recordId = button.dataset.recordId;
            const screenshotUrl = button.dataset.screenshotUrl;
            const container = document.getElementById(`screenshot-${recordId}`);
            
            if (!container) return;
            
            // 如果当前已展开，则收起
            if (container.classList.contains('active')) {
                container.classList.remove('active');
                button.classList.remove('active');
                button.innerHTML = '<i class="fas fa-image"></i> 查看截图';
                currentExpandedScreenshot = null;
                return;
            }
            
            // 收起之前展开的截图（一次只展开一个）
            if (currentExpandedScreenshot && currentExpandedScreenshot !== recordId) {
                const prevContainer = document.getElementById(`screenshot-${currentExpandedScreenshot}`);
                const prevButton = document.querySelector(`[data-record-id="${currentExpandedScreenshot}"]`);
                if (prevContainer) {
                    prevContainer.classList.remove('active');
                }
                if (prevButton) {
                    prevButton.classList.remove('active');
                    prevButton.innerHTML = '<i class="fas fa-image"></i> 查看截图';
                }
            }
            
            // 展开当前截图
            container.classList.add('active');
            button.classList.add('active');
            button.innerHTML = '<i class="fas fa-image"></i> 收起截图';
            currentExpandedScreenshot = recordId;
            
            // 如果截图还没有加载，则加载
            if (container.querySelector('.screenshot-loading')) {
                const img = document.createElement('img');
                img.loading = 'lazy';
                img.src = screenshotUrl;
                img.alt = '通关截图';
                img.onclick = function() {
                    // 点击图片在新窗口打开（使用 noopener,noreferrer 防止安全风险）
                    window.open(screenshotUrl, '_blank', 'noopener,noreferrer');
                };
                img.onerror = function() {
                    container.innerHTML = '<div class="screenshot-loading" style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> 截图加载失败</div>';
                };
                img.onload = function() {
                    container.innerHTML = '';
                    container.appendChild(img);
                };
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // 默认加载本地排行榜
            loadLocalRanking();
            
            // 标签页切换事件
            document.getElementById('local-tab-btn').addEventListener('click', () => switchTab('local'));
            document.getElementById('global-tab-btn').addEventListener('click', () => switchTab('global'));
            document.getElementById('floor-tab-btn').addEventListener('click', () => switchTab('floor'));
            
            // 本地排行榜按钮
            document.getElementById('back-btn').addEventListener('click', goToHomePage);
            document.getElementById('clear-local-btn').addEventListener('click', clearLocalRecords);
            
            // 联网排行榜按钮
            document.getElementById('back-btn-2').addEventListener('click', goToHomePage);
            document.getElementById('refresh-global-btn').addEventListener('click', loadGlobalRanking);
            
            // 层数排行榜按钮
            document.getElementById('back-btn-3').addEventListener('click', goToHomePage);
            document.getElementById('refresh-floor-btn').addEventListener('click', loadFloorRanking);
        });
    </script>
</body>
</html>