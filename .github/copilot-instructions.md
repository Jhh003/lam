# Copilot Instructions for LAM (边狱公司 - 今天蛋筒什么？)

## Project Overview

LAM is a web-based random selector application for the game "Limbus Company" (边狱公司). It helps players randomly select sinners and personas (identities) for gameplay, with additional features including:

- Random selection of 12 sinners and their associated personas
- Custom filtering options for sinners and personas
- Built-in timer for tracking run completion time
- Local and global ranking system for speedrun records
- Global online leaderboard using GitHub Issues as backend
- Beautiful bus-themed UI design with seasonal styling
- Easter egg video triggers for specific persona combinations

## Technology Stack

- **Frontend**: Pure HTML5, CSS3, JavaScript (ES6+ modules)
- **Build System**: None (static site, no build step required)
- **Package Manager**: npm (minimal, only for module type declaration)
- **Deployment**: GitHub Pages (static hosting)
- **Data Storage**: JSON files in `/data` directory
- **Backend**: GitHub Actions + GitHub Issues for global ranking
- **Icons**: Font Awesome 6.x

## Project Structure

```
lam/
├── .github/
│   ├── ISSUE_TEMPLATE/          # Issue templates for submitting records
│   │   ├── submit-clear-run.yml # Template for full clear records
│   │   └── submit-floor-only.yml # Template for floor-only records
│   └── workflows/
│       └── update-global-ranking.yml # Daily ranking aggregation workflow
├── assets/
│   ├── images/                  # Character avatars organized by sinner name
│   ├── fonts/                   # Custom fonts
│   └── media/                   # Video files for easter eggs
├── css/
│   ├── reset.css               # CSS reset
│   ├── common.css              # Common styles
│   ├── season.css              # Seasonal styling
│   └── module/                 # Modular CSS files
├── data/
│   ├── characters.js           # Sinner and persona data
│   ├── config.js               # Configuration constants
│   ├── global-ranking.json     # Time-based global ranking data
│   ├── global-floor-ranking.json # Floor-based global ranking data
│   └── utils/
│       └── helpers.js          # Utility functions
├── js/
│   ├── common.js               # Common features (countdown, timer, ranking upload)
│   ├── main.js                 # Main application logic
│   ├── filters.js              # Filter functionality
│   ├── scrolls.js              # Scroll list functionality
│   ├── settings.js             # Settings functionality
│   ├── modal.js                # Modal dialog functionality
│   └── ui.js                   # UI utility functions
├── scripts/
│   └── generate-global-ranking.mjs # Node.js script to aggregate ranking data from GitHub Issues
├── index.html                  # Main page
├── ranking.html                # Ranking page
└── package.json                # Project metadata
```

## Key Modules and Responsibilities

### JavaScript Modules (ES6)

1. **main.js**: Core application logic
   - Initializes the application
   - Manages sinner and persona selection
   - Handles scroll animations
   - Easter egg detection and playback

2. **common.js**: Common features (IIFE pattern)
   - Countdown timer to game season updates
   - Stopwatch timer for run tracking
   - Ranking upload to GitHub Issues
   - Modal integration for timer and upload

3. **filters.js**: Filter management
   - Sinner and persona filtering
   - Filter persistence in localStorage
   - Filter UI updates

4. **scrolls.js**: Scroll animations
   - Creates scroll lists for sinners and personas
   - Manages scroll start/stop animations
   - Handles item highlighting

5. **settings.js**: Settings management
   - Personality (persona) filter settings
   - Batch operations (toggle all, invert selection)
   - Settings persistence

6. **modal.js**: Modal dialogs
   - Alert, confirm, prompt dialogs
   - Custom modal windows
   - Timer modal with upload functionality

7. **ui.js**: UI utilities
   - DOM manipulation helpers
   - Image loading with fallbacks
   - Animation utilities

### Data Files

1. **characters.js**: 
   - Export: `sinnerData` array
   - Structure: Each sinner has id, name, avatar, color, and personalities array
   - Personalities: Each has name and avatar path

2. **config.js**:
   - Export: `Config` object
   - Contains application constants (scroll speeds, timing, etc.)

3. **global-ranking.json** & **global-floor-ranking.json**:
   - Auto-generated by GitHub Actions
   - Consumed by ranking.html
   - DO NOT manually edit

### Scripts

1. **generate-global-ranking.mjs**:
   - Node.js ES module script
   - Fetches issues with "通关记录" label
   - Parses issue body and validates data
   - Generates/updates ranking JSON files
   - Adds "已处理" label to processed issues

## Coding Conventions

### Language

- **Code Comments**: Chinese (中文注释)
- **Variable Names**: English camelCase
- **UI Text**: Chinese (Simplified)
- **Documentation**: Mixed (Chinese for user docs, English for technical docs)

### JavaScript

- **Module System**: ES6 modules with `type: "module"` in package.json
- **Import Style**: Named imports preferred, default for single export modules
- **Variable Declarations**: Use `const` by default, `let` when reassignment needed, avoid `var`
- **String Literals**: Single quotes for code strings, template literals for dynamic content
- **Functions**: Arrow functions for callbacks, regular functions for methods
- **Error Handling**: Try-catch for async operations, console.warn/error for logging

### HTML

- **Indentation**: 4 spaces
- **Semantic HTML**: Use semantic elements (header, nav, main, section, etc.)
- **Accessibility**: Include alt text, ARIA labels where appropriate
- **IDs vs Classes**: IDs for JavaScript hooks, classes for styling

### CSS

- **Naming Convention**: Kebab-case (e.g., `sinner-scroll-container`)
- **Organization**: Reset → Common → Season → Module-specific
- **Colors**: Use CSS variables or inline colors from character data
- **Responsive**: Mobile-first approach where applicable

### File Organization

- **Images**: Organize by sinner name in subdirectories
- **Supported formats**: `.jpg`, `.webp` for avatars
- **Fallback**: Display colored placeholder with "?" if image fails to load

## Data Flow

### Sinner/Persona Selection Flow

1. User configures filters in settings
2. Filters saved to localStorage
3. On page load, filters applied to sinnerData
4. User clicks start button → scroll animation begins
5. User clicks stop button → animation stops, item selected
6. Selected item displayed with avatar and name
7. Easter egg check performed (if conditions met)

### Ranking Upload Flow

1. User completes timer (≥2 hours for full record)
2. User clicks "上传全球榜" button
3. Validation: Check time, sinner, persona selection
4. Generate GitHub Issue URL with pre-filled form data
5. User submits GitHub Issue
6. GitHub Actions triggered by "通关记录" label
7. Script parses issue, validates data, updates JSON files
8. JSON files committed back to repository
9. Ranking page fetches updated JSON files

### Global Ranking Update Flow

```
GitHub Issue (submitted by user)
    ↓
GitHub Actions triggered (on label or schedule)
    ↓
generate-global-ranking.mjs runs
    ↓
Fetch issues with "通关记录" label
    ↓
Parse and validate issue body
    ↓
Filter valid records (time ≥ 7200s, etc.)
    ↓
Group by sinner and persona
    ↓
Sort by time (ascending) or floor level (descending)
    ↓
Write to global-ranking.json and global-floor-ranking.json
    ↓
Commit and push changes
    ↓
Add "已处理" label to issues
```

## Important Configuration

### Repository Configuration (js/common.js)

```javascript
const repoOwner = 'Jhh003'; // GitHub username
const repoName = 'lam';     // Repository name
```

**CRITICAL**: When deploying to a different repository, these values MUST be updated.

### Time Validation

- **Minimum upload time**: 7200 seconds (2 hours)
- **Defined in**: js/common.js (multiple locations)
- **For testing**: Can temporarily lower to 60s, but MUST revert before production

### Ranking Data Aggregation

- **Schedule**: Daily at 4:00 UTC (12:00 Beijing time)
- **Trigger**: Also on issue creation/labeling and manual workflow dispatch
- **Labels**: "通关记录" (for submission), "已处理" (for processed), "层数记录" (for floor-only)

## Build and Test

### Local Development

```bash
# Start local server (Python)
python -m http.server 8000

# Or with Node.js
npx http-server -p 8000
```

Then navigate to `http://localhost:8000`

### Testing

- **No automated tests**: Manual testing required
- **Test checklist**: See TEST_CHECKLIST.md
- **Key areas to test**:
  - Sinner/persona selection with various filter combinations
  - Timer functionality (start, stop, reset)
  - Upload to global ranking
  - Ranking page display (local and global tabs)
  - Easter egg triggers
  - Image loading and fallbacks

### Deployment

- **Platform**: GitHub Pages
- **Branch**: Main (or configured branch)
- **Folder**: Root (/)
- **No build step required**: Push to trigger deployment

## Common Tasks

### Adding a New Sinner

1. Add entry to `data/characters.js` sinnerData array
2. Add corresponding avatars to `assets/images/[SinnerName]/`
3. Update issue template in `.github/ISSUE_TEMPLATE/submit-clear-run.yml`
4. Test sinner selection, filtering, and ranking display

### Adding a New Persona

1. Add to appropriate sinner's personalities array in `data/characters.js`
2. Add avatar image to `assets/images/[SinnerName]/`
3. Update issue template dropdown options
4. Test persona selection and filtering

### Modifying Time Constraints

1. Update validation in `js/common.js` (uploadToGlobalRanking function)
2. Update issue template description/validation
3. Update `scripts/generate-global-ranking.mjs` (MIN_CLEAR_TIME constant)
4. Update user documentation

### Adding Easter Eggs

1. Add video file to `assets/media/`
2. Update easter egg detection logic in `js/scrolls.js` or `js/main.js`
3. Define conditions for triggering (specific sinner + persona combination)
4. Test trigger conditions and video playback

## Security Considerations

- **GitHub Token**: Automatically provided by GitHub Actions as `GITHUB_TOKEN`
- **No user authentication**: All submissions via public GitHub Issues
- **Data validation**: Server-side validation in aggregation script
- **No sensitive data**: All ranking data is public
- **XSS Prevention**: Sanitize user input from issue bodies before displaying

## Best Practices for AI Assistance

### When Modifying JavaScript

1. **Check imports**: Ensure all required modules are imported
2. **Module type**: Remember this is ES6 modules project
3. **localStorage**: Consider persistence for filters/settings
4. **Error handling**: Add try-catch for async operations
5. **Console logging**: Add informative logs for debugging

### When Modifying HTML

1. **Maintain structure**: Keep existing ID/class naming conventions
2. **Script type**: Use `type="module"` for ES6 module scripts
3. **Accessibility**: Include proper ARIA labels
4. **Semantic HTML**: Use appropriate semantic elements

### When Modifying CSS

1. **Check reset.css**: Understand base styles before adding new rules
2. **Module organization**: Add styles to appropriate module file
3. **Responsive design**: Test on mobile viewport sizes
4. **Color scheme**: Match existing edge/cyberpunk aesthetic

### When Modifying Data

1. **characters.js**: Maintain data structure (id, name, avatar, color, personalities)
2. **Validate paths**: Ensure avatar paths are correct and images exist
3. **No direct JSON edits**: Don't manually edit global-ranking.json files
4. **Backup data**: Consider backing up before major data changes

### When Modifying GitHub Actions

1. **Test locally first**: Use `act` or similar tools if possible
2. **Secrets**: Use `secrets.GITHUB_TOKEN`, not personal access tokens
3. **Permissions**: Ensure workflow has write permissions
4. **Error handling**: Add proper error messages and logging

## Troubleshooting

### Common Issues

1. **Module not found**: Check import paths are correct (relative paths required)
2. **CORS errors**: Use local server, don't open HTML directly in browser
3. **Images not loading**: Check file paths and extensions (.jpg vs .webp)
4. **localStorage issues**: Check browser privacy settings
5. **Ranking not updating**: Verify GitHub Actions ran successfully
6. **Upload button disabled**: Check time threshold and selection state

### Debug Tips

- Open browser console (F12) for error messages
- Check Network tab for failed resource loads
- Use `console.log` liberally for state tracking
- Verify GitHub Actions logs for workflow failures

## Version History

Current version: 1.5.0

Major features by version:
- **1.5.0**: Refactored upload UI, separate full/floor-only record submission
- **1.4.0**: Added floor level ranking system
- **1.3.1**: Increased minimum upload time to 2 hours, added E.G.O field
- **1.3.0**: Global online ranking system implementation
- **1.2.x**: Timer and local ranking features
- **1.1.x**: Modularization and code restructuring

## Additional Resources

- README.md: User-facing documentation (Chinese)
- QUICK_START.md: Quick start guide for deployment
- GLOBAL_RANKING_GUIDE.md: Guide for global ranking feature
- TEST_CHECKLIST.md: Testing checklist
- IMPLEMENTATION_SUMMARY.md: Feature implementation details

## Notes for AI Assistants

- **Preserve existing functionality**: This is a complete, working application
- **Chinese context**: User-facing text should be in Chinese
- **No breaking changes**: Maintain backward compatibility with localStorage data
- **Test thoroughly**: Manual testing is critical for UI/UX features
- **GitHub integration**: Be careful with changes that affect the GitHub Actions workflow
- **Documentation**: Update relevant .md files when making significant changes
